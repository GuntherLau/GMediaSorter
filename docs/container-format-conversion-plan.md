# 容器格式转换功能方案

## 1. 背景与目标
- 在应用菜单栏中新增“容器格式转换”入口，为用户提供批量的视频封装格式（container format）转换能力。
- 首期支持 MP4 与 MKV 两种目标格式，后续可扩展至 MOV、AVI 等更多格式。
- 操作流程应与现有的视频编码转换体验保持一致：一键选择目标格式 → 选择输出目录 → 批量执行。

## 2. 用户体验设计
### 2.1 菜单入口
- 在 Electron 主进程的菜单栏（工具菜单下）新增“容器格式转换”按钮。
- 点击后在渲染进程显示下拉列表（或弹窗）列出可选的目标容器格式（初期仅 MP4、MKV）。

### 2.2 交互流程
1. 用户点击菜单项，渲染进程弹出容器格式选择面板（下拉列表或 dialog）。
2. 用户选择目标容器格式。
3. 触发系统文件夹选择窗口，让用户指定输出目录。
4. 对当前选中的视频文件（若未选中则默认全部过滤后的列表，沿用现有逻辑）逐个执行容器格式转换并输出到指定目录。
5. 完成后展示结果面板，显示成功/失败列表，并提供打开目录、查看日志等快捷操作。

## 3. 功能范围
- 支持将常见视频封装格式转换为 MP4 或 MKV，同时保持音视频编码不变（仅调整封装容器）。
- 可以复用现有转换任务的进度展示、取消、日志记录与结果弹窗能力。
- 需考虑原始文件名称冲突处理，沿用现有的 `resolveOutputPath` 逻辑（添加后缀与自增计数）。

## 4. 技术实现要点
### 4.1 渲染层
- 新增容器格式选择 UI 组件，提供 MP4/MKV 选项和确认按钮。
- 复用或扩展当前的转换状态管理逻辑，追加 `ContainerConversionRequest` 类型（目标容器、文件列表、输出目录）。
- 新增 Electron IPC 调用方法，例如 `requestContainerConversion`、`onContainerConversionProgress`、`onContainerConversionComplete`。

### 4.2 主进程
- 在 `electron/main.ts` 注册新菜单项、IPC 处理器。
- 复用转换服务或新增 `ContainerConversionService`：
  - 使用 `ffmpeg` 的 `copy` 编码策略，实现无损封装转换（`-c copy`）。
  - 处理输出后缀、冲突检测、取消逻辑与日志记录。

### 4.3 类型与共享模块
- 在 `src/types.ts` 定义容器转换相关类型（请求、进度、结果等）。
- 更新 `preload.ts` 暴露新的 API。

### 4.4 错误处理与日志
- 失败时提供明确的错误信息（例如输入文件损坏、目标容器不支持等）。
- 将每个任务的成功/失败结果写入现有日志文件，便于追踪。

## 5. 任务拆分进度

| 序号 | 任务 | 状态 | 备注 |
| --- | --- | --- | --- |
| 1 | 需求确认与设计 | ✅ 已完成 | 采用弹窗式格式选择面板，默认对当前过滤列表进行批量转换；结果面板沿用现有样式并标注容器转换类型。 |
| 2 | 类型与 IPC 扩展 | ✅ 已完成 | 定义容器转换相关类型，并在主进程/预加载层注册 IPC。|
| 3 | 菜单入口与渲染层 UI | ✅ 已完成 | 新增容器转换菜单、进度与结果对话框，并接入工具栏入口。|
| 4 | 主进程服务实现 | ✅ 已完成 | 引入 ContainerConversionService，完成 ffmpeg remux、日志与 IPC 事件。|
| 5 | 整合与验证 | ✅ 已完成 | 新增容器转换端到端事件流与自动化测试，覆盖成功/失败/取消场景。 |
| 6 | 文档与上线准备 | ✅ 已完成 | README、CHANGELOG、测试指南与用户指南同步容器转换说明。 |

以下为各任务的详细说明：

2. **类型与 IPC 扩展**
   - 更新 `src/types.ts` 添加容器转换类型定义。
   - 更新 `electron/preload.ts` 暴露新 API。
   - 更新 `electron/main.ts` 注册新 IPC 处理器。

3. **菜单入口与渲染层 UI**
   - 在 Electron 菜单中新增“容器格式转换”项。
   - 新增前端 UI 组件（格式选择 + 输出目录选择）。
   - 接入现有的进度与结果弹窗。
   - ✅ 已实现：`ContainerConversionMenu`、`ContainerConversionProgressDialog`、`ContainerConversionResultDialog` 以及工具栏入口，统一复用现有样式与交互。

4. **主进程服务实现**
   - 复用/新增转换服务，实现 `ffmpeg -c copy` 的容器转换流程。
   - 实现任务排队、取消、重试策略（若需要）。
   - 写入成功/失败日志。
   - ✅ 已实现：新增 `ContainerConversionService`，覆盖 remux、取消、日志与 IPC 通道；若输入文件已是目标容器，则跳过 remux 并执行快速复制。

5. **整合与验证**
   - ✅ 渲染层发起容器转换任务并订阅进度/结果，完成菜单触发、进度回放与结果对话框闭环。
   - ✅ 新增 `electron/services/__tests__/container-conversion-service.test.ts`，覆盖成功、失败、取消与“已是目标容器快速复制”链路，并验证进度统计。
   - ✅ 记录异常场景检查项（目录权限、重复命名、任务并发）以便回归时复用。

6. **文档与上线准备**
   - ✅ 更新 README、CHANGELOG、TESTING、USER_GUIDE，补充容器转换功能说明与验证步骤。
   - ✅ 在测试指南中注明 `npm run test` 自动化用例与手工验证矩阵。

## 6. 后续扩展
- 增加更多容器格式选项（MOV、AVI、MPG 等）。
- 支持自定义封装参数（如字幕流保留、音频重封装策略）。
- 与现有编码转换功能整合，提供“一站式”转换面板，可同时选择编码和容器。
