# 视频分辨率过滤功能规划

## 背景与目标

当前 GMediaSorter 已能够扫描指定目录下的视频文件，并显示基础信息（名称、大小、修改时间、扩展名），但缺少按视频分辨率筛选的能力。用户希望在界面中提供以下四种过滤选项：

- 720p
- 1080p
- 小于 720p
- 大于 1080p

该文档旨在定义实现该功能所需的技术方案、接口设计和分阶段任务，作为后续迭代开发与验收的依据。

## 总体思路

1. **收集视频分辨率元数据**：在扫描文件时解析出每个视频的宽度和高度。
2. **扩展数据模型**：在 IPC 传输数据中加入分辨率字段，供前端过滤使用。
3. **前端状态与过滤逻辑**：在 React 层维护当前选中的过滤器，并根据用户选择对列表做实时筛选。
4. **交互与展示**：提供清晰的过滤控件与状态提示，支持随时切换和清除过滤。

## 技术方案

### 1. 元数据解析

- **方式选择**：
  - 推荐使用 [`ffprobe-static`](https://www.npmjs.com/package/ffprobe-static) 搭配 [`fluent-ffmpeg`](https://www.npmjs.com/package/fluent-ffmpeg) 或者 [`ffprobe`](https://www.npmjs.com/package/ffprobe) 直接调用。
  - 优点：跨平台、无需用户手动安装 FFmpeg（`ffprobe-static` 自带预编译二进制）。

- **实现要点**：
  - 在 Electron 主进程中对每个视频文件调用 ffprobe，提取 `width`、`height`、`display_aspect_ratio` 等字段。
  - 控制并发数量（例如使用 `p-limit`）以避免在大量文件时阻塞主进程。
  - 对失败的文件返回空的分辨率数据，并在日志中记录。
  - 计算过滤所需的“有效垂直分辨率”时，使用 `Math.min(width, height)` 处理横屏与竖屏视频，避免仅按高度判断导致旋转视频被误分组。

### 2. IPC 数据结构调整

- **主进程 (`electron/main.ts`)**：
  - `get-video-files` handler 在返回列表中新增字段：
    - `width: number | null`
    - `height: number | null`
    -（可选）`resolutionLabel: 'lt720p' | '720p' | '1080p' | 'gt1080p' | null`（基于 `Math.min(width, height)` 生成，以兼容横竖屏）

- **预加载脚本 (`electron/preload.ts`)**：
  - 更新暴露给渲染进程的 TypeScript 类型，确保新增字段可访问。

- **共享类型 (`src/types.ts`)**：
  - 为 `VideoFile` 接口新增对应字段。
  - 若使用 `resolutionLabel` 预计算标签，也在类型中体现。

### 3. 渲染进程逻辑

- **状态管理**：
  - 在 React 组件中新增 `resolutionFilter` 状态，默认值为 `'all'`。

- **过滤选项**：
  - 提供四个单选按钮或下拉选择框：
    - `lt720p` → 有效垂直分辨率 `< 720`
    - `720p` → 有效垂直分辨率在 `720 ± 容差`（默认 ±16 px）
    - `1080p` → 有效垂直分辨率在 `1080 ± 容差`
    - `gt1080p` → 有效垂直分辨率 `> 1080`
  - 保留 “全部” 选项用于清除过滤。

- **过滤计算**：
  - 对 `videoFiles` 进行派生过滤（例如使用 `useMemo`），保证原始数据不被修改。
  - 对缺失分辨率的数据可选择：
    - 默认显示在 “全部” 中，或
    - 单独提示“未获取分辨率”。

- **UI 展示**：
  - 在视频卡片中增加分辨率展示，例如 `1920 × 1080`。
  - 在列表顶部显示当前过滤器标签和命中数量。

### 4. 性能与体验

- **延迟加载**：
  - 若目录中文件很多，可以先返回基础信息，再增量补充分辨率（可选高级优化）。

- **错误处理**：
  - 对缺少编码信息的视频显示“未知分辨率”。
  - 在 DevTools 中输出错误日志，便于开发调试。

## 拆分任务

| 阶段 | 任务 | 说明 |
| ---- | ---- | ---- |
| Phase 1 | 依赖与工具准备 | 安装 `ffprobe-static`、`fluent-ffmpeg` 等依赖，编写封装函数获取分辨率 |
| Phase 1 | 类型与数据模型更新 | 更新主进程、预加载、前端共享类型中的 `VideoFile` 定义 |
| Phase 1 | IPC 返回值扩展 | 修改 `get-video-files` handler，确保返回分辨率数据 |
| Phase 2 | 渲染层状态管理 | 在 React 中加入 `resolutionFilter` 状态和过滤逻辑 |
| Phase 2 | UI 控件与样式 | 实现过滤选项控件、命中数量显示、卡片信息更新 |
| Phase 3 | 错误与性能优化 | 处理 ffprobe 失败、并发控制、日志记录 |
| Phase 3 | 测试与验证 | 编写单元/集成测试（如可行），手动验证各过滤条件表现 |
| Phase 4 (可选) | 增强功能 | 例如按宽高自定义范围过滤、组合其他条件过滤 |

## 验收标准

1. 在任意目录选择视频后，界面可展示每个视频的分辨率。
2. 选择“四个预设过滤器”任意一项，视频列表只显示符合条件的内容。
3. 切换过滤选项时，界面更新无明显卡顿。
4. 对无法获取分辨率的视频已有合理提示或 fallback 处理。
5. 所有新增字段有清晰的类型定义与注释。

## 后续扩展建议

- 支持自定义分辨率范围过滤（输入最小/最大值）。
- 与文件大小、格式等条件进行组合过滤。
- 缓存已解析的分辨率信息，以减少重复扫描耗时。
- 引入队列或后台任务，在大量视频时逐步更新分辨率。

---

*本方案作为分辨率过滤功能的设计基准，后续开发可按阶段逐步实现并验证。*
