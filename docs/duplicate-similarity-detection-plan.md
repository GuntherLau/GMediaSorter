# 视频去重与相似检测功能规划

## 背景与目标

当前 GMediaSorter 已支持视频文件扫描、分辨率过滤等基础功能。用户在管理大量视频时，常遇到以下问题：

1. **重复文件**：同一视频以不同文件名保存多份，占用存储空间
2. **相似视频**：内容有重叠的视频片段，需要人工筛选整理

本方案旨在提供智能化的重复和相似视频检测能力，通过工具栏集成"找相同"和"找相似"两个核心功能。

## 功能概述

### 操作栏/工具栏设计

在视频列表顶部（过滤栏下方或同级）新增操作工具栏，包含：

- **找相同**：检测完全重复的视频文件（基于文件内容哈希）
- **找相似**：检测内容相似的视频（基于视频特征指纹）
- **批量操作**（预留）：删除、移动、标记等
- **导出结果**（预留）：导出检测报告

### 功能 1：找相同（重复文件检测）

#### 原理与方案

**核心思路**：通过计算文件内容哈希值来判定是否为同一文件。

##### 方案 A：完整文件哈希（推荐）

- **算法**：MD5、SHA-256 或 xxHash（性能优先）
- **实现**：
  - 在主进程中读取视频文件并计算哈希
  - 使用流式读取避免大文件内存溢出
  - 相同哈希值的文件归为一组
  
- **优点**：
  - 100% 准确，不会误判
  - 实现简单，无需外部依赖
  
- **缺点**：
  - 大文件计算耗时较长
  - 需要读取完整文件内容

##### 方案 B：快速哈希（性能优化）

- **算法**：仅读取文件头部、中部、尾部片段计算哈希
- **实现**：
  - 读取前 64KB + 中间 64KB + 后 64KB
  - 组合计算哈希值
  
- **优点**：
  - 速度快，适合大文件
  - 对于完全相同的文件依然准确
  
- **缺点**：
  - 极小概率碰撞（不同文件片段相同）

##### 推荐方案：两阶段检测

1. **快速筛选**：先用快速哈希初步分组
2. **精确验证**：对疑似重复的文件进行完整哈希验证

#### 数据结构

```typescript
interface DuplicateGroup {
  id: string;                    // 组 ID
  hash: string;                  // 文件哈希值
  files: VideoFile[];            // 重复文件列表
  totalSize: number;             // 总占用空间
  wasteSize: number;             // 冗余空间（除保留一个外）
  representativeFile: VideoFile; // 代表文件（最早/最小等）
}

interface DuplicateResult {
  groups: DuplicateGroup[];      // 所有重复组
  totalDuplicates: number;       // 重复文件总数
  totalWasteSize: number;        // 总冗余空间
  scanTime: number;              // 扫描耗时
}
```

#### 用户交互流程

1. 用户点击"找相同"按钮
2. 显示进度对话框（扫描进度、已处理文件数）
3. 完成后显示结果面板：
   - 总览：发现 X 组重复，共 Y 个文件，浪费 Z MB 空间
   - 分组列表：每组显示文件列表，支持预览、标记保留/删除
4. 提供批量操作：保留最新/最大/自定义，删除其余

### 功能 2：找相似（内容相似检测）

#### 原理与方案

**核心思路**：提取视频内容特征，计算特征相似度。

##### 方案 A：感知哈希（pHash）

- **算法**：基于视频帧的感知哈希
- **实现**：
  - 使用 ffmpeg 提取关键帧（如每 5 秒一帧）
  - 计算每帧的 pHash 值
  - 比较两个视频的 pHash 序列相似度
  
- **库选择**：
  - `sharp` + 自实现 pHash
  - `image-hash` 库
  
- **优点**：
  - 对压缩、缩放、色彩调整具有鲁棒性
  - 可检测裁剪、片段重组的视频
  
- **缺点**：
  - 计算量较大
  - 需要解码视频帧

##### 方案 B：视频指纹（Video Fingerprinting）

- **算法**：提取视频的时间-频率特征
- **实现**：
  - 使用 ffmpeg 提取音频波形特征
  - 结合关键帧的颜色直方图
  - 生成视频指纹向量
  
- **优点**：
  - 更精确，可识别部分重叠
  - 对编辑、添加水印等操作鲁棒
  
- **缺点**：
  - 实现复杂度高
  - 需要专业音视频处理知识

##### 方案 C：元数据 + 简单特征（快速方案）

- **特征组合**：
  - 视频时长（±5% 容差）
  - 分辨率
  - 文件大小（±10% 容差）
  - 首帧、中间帧、末帧的颜色直方图
  
- **相似度计算**：
  - 多维度加权打分
  - 设定阈值（如 80% 相似）
  
- **优点**：
  - 实现简单，无需复杂库
  - 速度快
  
- **缺点**：
  - 准确度较低
  - 无法识别深度编辑的视频

##### 推荐方案：分级检测

1. **L1 - 快速筛选**：元数据 + 简单特征（时长、分辨率、大小）
2. **L2 - 感知哈希**：对 L1 匹配的视频对进行 pHash 比对
3. **L3 - 用户确认**：展示疑似相似组，由用户最终判定

#### 数据结构

```typescript
interface SimilarityScore {
  duration: number;      // 时长相似度 0-1
  resolution: number;    // 分辨率相似度 0-1
  fileSize: number;      // 文件大小相似度 0-1
  visual: number;        // 视觉相似度 0-1（pHash）
  overall: number;       // 综合相似度 0-1
}

interface SimilarPair {
  file1: VideoFile;
  file2: VideoFile;
  similarity: SimilarityScore;
  overlapFrames?: number;    // 重叠帧数（可选）
  overlapDuration?: number;  // 重叠时长（可选）
}

interface SimilarGroup {
  id: string;
  files: VideoFile[];        // 相似文件组
  avgSimilarity: number;     // 平均相似度
  pairs: SimilarPair[];      // 两两配对详情
}

interface SimilarityResult {
  groups: SimilarGroup[];
  totalSimilarFiles: number;
  scanTime: number;
  threshold: number;         // 使用的相似度阈值
}
```

#### 用户交互流程

1. 用户点击"找相似"按钮
2. 弹出配置对话框：
   - 相似度阈值（滑块：60%-95%，默认 80%）
   - 检测维度（时长、大小、内容等）
3. 显示进度对话框（当前进度、预计剩余时间）
4. 完成后显示结果面板：
   - 总览：发现 X 组相似视频，共 Y 个文件
   - 分组列表：每组显示相似度、文件列表
   - 支持并排预览对比
5. 提供操作：标记保留、删除、合并标签等

## 技术方案

### 架构设计

#### 主进程（Electron）

```
electron/
├── main.ts                    # 现有主进程
├── utils/
│   ├── hash.ts               # 哈希计算工具
│   ├── video-fingerprint.ts  # 视频指纹提取
│   └── similarity.ts         # 相似度计算
└── services/
    ├── duplicate-detector.ts # 重复检测服务
    └── similarity-detector.ts # 相似检测服务
```

#### IPC 通信接口

```typescript
// 重复检测
ipcMain.handle('detect-duplicates', async (event, files: VideoFile[], options) => {
  // 返回 DuplicateResult
});

// 相似检测
ipcMain.handle('detect-similarity', async (event, files: VideoFile[], options) => {
  // 返回 SimilarityResult
});

// 取消检测
ipcMain.handle('cancel-detection', async (event, taskId: string) => {
  // 中止长时间任务
});

// 获取检测进度
ipcMain.on('detection-progress', (progress: DetectionProgress) => {
  // 主进程推送进度给渲染进程
});
```

#### 渲染进程（React）

```
src/
├── components/
│   ├── Toolbar.tsx           # 工具栏组件
│   ├── DuplicatePanel.tsx    # 重复结果面板
│   ├── SimilarityPanel.tsx   # 相似结果面板
│   └── ProgressDialog.tsx    # 进度对话框
├── hooks/
│   ├── useDuplicateDetection.ts
│   └── useSimilarityDetection.ts
└── utils/
    └── format.ts             # 格式化工具（大小、时长等）
```

### 依赖选择

#### 必需依赖

- **哈希计算**：Node.js 内置 `crypto` 模块（MD5、SHA-256）
- **快速哈希**：`xxhash-addon` 或 `xxhash-wasm`
- **视频处理**：已有 `fluent-ffmpeg` + `ffprobe-static`
- **图像处理**：`sharp`（帧提取和处理）
- **感知哈希**：`blockhash-core` 或自实现

#### 可选依赖

- **进度报告**：`p-queue` 或 `p-limit`（已有）
- **并发控制**：已有 `p-limit`
- **工作线程**：Node.js 内置 `worker_threads`（大量计算时）

### 性能优化策略

1. **增量扫描**：缓存已计算的哈希值/指纹
2. **并发控制**：限制同时处理的文件数
3. **中断恢复**：支持暂停和继续
4. **后台处理**：使用 Worker 线程避免阻塞主进程
5. **分块处理**：大文件流式读取
6. **结果缓存**：将检测结果持久化到本地数据库

### UI/UX 设计

#### 工具栏布局

```
+----------------------------------------------------------+
| 分辨率过滤: [全部] [<720p] [720p] [1080p] [>1080p]      |
+----------------------------------------------------------+
| 操作工具: [🔍 找相同] [🎯 找相似] [⚙️ 更多] | 找到 50 个视频 |
+----------------------------------------------------------+
```

#### 检测结果面板

**重复文件面板**：
```
┌─ 重复文件检测结果 ──────────────────────────────┐
│ 发现 3 组重复，共 8 个文件，浪费 2.3 GB 空间    │
├─────────────────────────────────────────────────┤
│ 组 1: (3 个文件, 共 800 MB)                      │
│   ✓ video_1.mp4    [保留] 800 MB  2025-01-15   │
│   ⊗ video_copy.mp4 [删除] 800 MB  2025-01-16   │
│   ⊗ backup.mp4     [删除] 800 MB  2025-01-17   │
│   [保留最新] [保留最大] [全部删除]              │
├─────────────────────────────────────────────────┤
│ 组 2: (2 个文件, 共 1.5 GB)                     │
│   ...                                            │
└─────────────────────────────────────────────────┘
```

**相似视频面板**：
```
┌─ 相似视频检测结果 ──────────────────────────────┐
│ 发现 2 组相似视频，共 5 个文件 (阈值: 80%)      │
├─────────────────────────────────────────────────┤
│ 组 1: 相似度 85% (2 个文件)                      │
│   📹 video_a.mp4   1920x1080  5:30  500 MB     │
│   📹 video_a_edit.mp4  1920x1080  5:25  480 MB │
│   [并排预览] [详细对比] [标记关联]              │
├─────────────────────────────────────────────────┤
│ 组 2: 相似度 78% (3 个文件)                     │
│   ...                                            │
└─────────────────────────────────────────────────┘
```

## 实施计划

### Phase 1: 工具栏基础框架

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 设计工具栏组件 | 创建 Toolbar.tsx，集成到主界面 | 2h |
| 定义 IPC 接口 | 定义检测相关的 IPC 通信协议 | 1h |
| 进度对话框组件 | 创建通用的进度展示组件 | 2h |

### Phase 2: 找相同功能

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 哈希计算工具 | 实现快速哈希和完整哈希 | 4h |
| 重复检测服务 | 主进程检测逻辑 | 6h |
| 结果面板 UI | DuplicatePanel 组件 | 4h |
| 批量操作功能 | 保留/删除/移动逻辑 | 4h |
| 测试与优化 | 性能测试、边界情况 | 4h |

### Phase 3: 找相似功能

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 特征提取工具 | 实现帧提取、pHash 计算 | 8h |
| 相似度计算 | 多维度相似度算法 | 6h |
| 相似检测服务 | 主进程检测逻辑 | 6h |
| 结果面板 UI | SimilarityPanel 组件 | 4h |
| 并排预览功能 | 视频对比播放器 | 6h |
| 测试与优化 | 算法调优、性能测试 | 6h |

### Phase 4: 优化与增强

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 结果缓存 | 持久化检测结果 | 4h |
| 增量检测 | 仅检测新增文件 | 4h |
| 批量操作增强 | 高级过滤、自动化规则 | 6h |
| 导出报告 | 生成检测报告（JSON/CSV） | 3h |
| 文档完善 | 用户手册、API 文档 | 3h |

**总预估工作量**：约 80-100 小时

## 验收标准

### 找相同功能

1. ✅ 能准确检测出完全重复的视频文件
2. ✅ 显示重复组、文件数量、空间占用
3. ✅ 支持批量删除/保留操作
4. ✅ 对大文件（>1GB）检测时间 < 5 秒/文件
5. ✅ 支持中断和恢复检测
6. ✅ 错误处理完善，无崩溃风险

### 找相似功能

1. ✅ 能检测出相似度 ≥ 设定阈值的视频组
2. ✅ 相似度判定误差 < 5%
3. ✅ 显示相似度评分、配对详情
4. ✅ 支持并排预览对比
5. ✅ 检测速度可接受（< 10 秒/文件）
6. ✅ 支持自定义阈值和检测维度

### 通用要求

1. ✅ UI 响应流畅，无卡顿
2. ✅ 进度提示准确，可随时取消
3. ✅ 所有操作可撤销或二次确认
4. ✅ 异常情况有友好提示
5. ✅ 完整的文档和示例

## 技术风险与应对

### 风险 1：大文件处理性能

- **影响**：处理 GB 级文件时内存占用高、耗时长
- **应对**：
  - 使用流式读取
  - 快速哈希预筛选
  - Worker 线程隔离

### 风险 2：感知哈希准确度

- **影响**：误判率较高或漏判
- **应对**：
  - 多帧采样提高准确度
  - 可调阈值给用户选择权
  - 人工二次确认机制

### 风险 3：ffmpeg 跨平台兼容性

- **影响**：不同系统帧提取结果不一致
- **应对**：
  - 统一 ffmpeg 版本和参数
  - 充分测试 Windows/macOS/Linux
  - 提供降级方案

### 风险 4：用户误操作删除

- **影响**：用户批量删除后无法恢复
- **应对**：
  - 删除前强制二次确认
  - 提供"移到回收站"选项
  - 操作日志记录

## 后续扩展方向

1. **智能推荐**：基于检测结果自动推荐清理方案
2. **云端指纹库**：共享视频指纹数据库，提升检测效率
3. **AI 内容识别**：使用机器学习识别视频内容分类
4. **定时任务**：自动定期扫描新增文件
5. **规则引擎**：用户自定义自动化清理规则
6. **统计分析**：视频库健康度报告、存储优化建议

---

*本方案作为视频去重与相似检测功能的设计基准，后续开发可按阶段逐步实现并验证。*
