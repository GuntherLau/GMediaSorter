# 动态视频拼墙功能方案

## 1. 功能命名与定位
- 推荐名称：**动态视频拼墙**（Dynamic Video Mosaic）。
- 功能目标：基于用户当前选中的视频集合，全屏呈现多源瀑布流播放，营造沉浸式、不断轮播的拼墙体验。

## 2. 需求概述
- 当过滤后的列表存在视频时，菜单栏出现“动态视频拼墙”入口。
- 打开后默认申请全屏，便于直接进入沉浸式体验。
- 进入全屏模式后，以瀑布流布局同时播放多段视频，支持不同长宽比。
- 任一视频播放完毕后，从待播队列随机补位，实现持续轮换。
- 用户可随时退出全屏，返回常规浏览视图。
- 默认列数为 3，可在主界面设置入口选择 2~5 列。

## 3. 用户流程
1. 选择目录并设置过滤条件 → 当前列表存在视频时入口可用。
2. 点击入口 → 请求全屏 → 展示加载提示 → 渲染瀑布流布局。
3. 全屏播放 → 所有视频自动同步播放，界面保持纯画面展示，仅保留 `Esc` 退出。
4. 视频播放结束 → 随机切换新视频 → 循环。
5. 用户按 `Esc` 退出全屏并返回主界面。

## 4. 布局与渲染
- 现阶段实现“不断变化的拼贴”式自由布局，根据视频宽高比生成大小不一的卡片并在无重叠的网格内随机排布。
- 列数设置转化为密度系数，控制同时展示的数量，布局自动在宽高比变化时重排，兼容不同屏幕尺寸。
- 卡片使用 CSS Grid 定位与渐进动画，结合 `object-fit: cover` 降低黑边并营造层叠感。
- 全屏模式仅呈现视频本身，不额外叠加控制面板，按 `Esc` 即可退出。
- 上线前评估性能，必要时迁移至 `@egjs/react-infinitegrid` 或引入虚拟化。

## 5. 播放调度
- 记录 `activeSlots`（当前播放）与 `waitingQueue`（待播池），保持播放源公平轮换。
- `waitingQueue` 按需随机洗牌，优先补位未在播的视频源，减少重复曝光。
- 监听 `ended`/`error` 事件触发补位，确保交叉场景下仍可平稳调度。
- 设置最大并发数量与最小播放时长，避免频繁刷新与卡顿。
- 音频策略默认静音，可选“随机单源有音”；当前实现默认开启单源音频轮换，每隔固定时段切换有声瓦片，避免多源混音干扰。

## 6. 技术架构
- 新增 `VideoMosaicLauncher`（入口按钮）、`VideoMosaicScreen`（全屏容器）。
- 使用 `React.Portal` 渲染至根节点之外，确保层级最高。
- 扩展应用状态：`mosaicState = { visible, queue, settings }`。
- 复用 `openFilePreview` 获取 `gms-media://` URL，必要时新增缓存/探测接口。

## 7. 性能与资源
- 提供性能预设（低：6 源，中：12 源，高：18 源），影响并发瓦片上限、洗牌批次与预加载数量。
- 超过上限时提示用户或自动抽样。
- 预加载待播队列前 N 个资源，减少补位时的首帧卡顿。
- 引入播放失败冷却与待播队列轮换，防止反复尝试异常视频。
- 出错后快速跳过，避免卡槽。

## 8. 兼容性与边界
- 文件缺失/权限异常 → 弹出提示并从队列移除。
- 编码不支持 → 记录并跳过。
- 全屏失败 → 回退到遮罩视图并提示快捷键。
- 应用最小化或窗口失焦 → 自动暂停（可配置）。

## 9. 实施阶段与任务拆分
| 序号 | 任务 | 描述 | 状态 |
| --- | --- | --- | --- |
| 1 | 原型验证 | 使用 mock 数据 + `react-masonry-css` 搭建最小可运行全屏瀑布流，验证随机播放逻辑与全屏切换 | ☑ 已完成 (2025-11-15) |
| 2 | 入口与状态管理 | 在工具栏/菜单加入入口，基于当前过滤结果批量请求 `openFilePreview` URL | ☑ 已完成 (2025-11-15) |
| 3 | 播放调度与音频策略 | 实现播放队列、并发限制、随机补位、音频控制 | ☑ 已完成 (2025-11-15) |
| 4 | 控制面板与用户交互 | 全屏浮层 UI、快捷键、退出流程、提示信息 | ☑ 已完成 (2025-11-15) |
| 5 | 性能优化 | 预加载策略、错误恢复、并发预设、必要时引入虚拟化库 | ☑ 已完成 (2025-11-15) |
| 6 | 测试与文档 | 自动化测试（组件/调度）、手工测试清单、更新用户指南 | ☑ 已完成 (2025-11-15) |

> 任务记录：
> - 原型验证：通过 `#mosaic-prototype` 哈希切换至全屏演示页，默认申请全屏并采用纯视频网格；当前以真实过滤结果为主要数据源，缺少可用视频时展示空状态指引。
> - 入口与状态管理：Toolbar 新增“动态视频拼墙”按钮与列数设置入口，基于当前过滤结果批量请求 `openFilePreview`，生成全屏拼墙所需的资源列表并在加载态、错误态下给出提示。
> - 拼贴布局：对标 macOS “不断变化的拼贴”屏保，按视频宽高生成随机卡片并在无重叠网格中周期性重排，提升屏幕覆盖率与视觉动感。
> - 音频与性能：限制并发瓦片上限、维护待播队列优先补位唯一视频源，并启用单源轮换音频以兼顾沉浸感与流畅度。
> - 控制交互：全屏状态下不渲染额外 UI，通过系统 `Esc` 退出并监听键盘事件兜底。
> - 性能策略：提供多档性能预设、实现待播资源预加载与错误源冷却，减轻高并发播放时的卡顿与重复错误。
> - 测试与文档：新增 `VideoMosaicPrototype` 组件测试覆盖并发上限、音频轮换与错误替换场景；扩充测试指南与用户手册，加入动态拼墙的操作说明与验收清单。

## 10. 测试计划
- **自动化**：
  - 单元：调度算法、状态管理（Vitest）。
  - 组件：全屏挂载、布局渲染（Testing Library）。
- **手工测试**：
  - 不同视频数量、编码、分辨率组合。
  - 性能预设、音频策略切换。
  - 入口禁用提示、全屏失败回退。

## 11. 风险与对策
- **硬件瓶颈**：提供性能预设与提示，允许用户降级。
- **格式兼容**：复用现有元数据检测，提前过滤不支持格式。
- **资源占用**：限制并发播放，加速错误恢复，必要时暂停后台播放。

---
> 后续推进时，请在对应任务完成后更新上表状态，并补充实际实现细节、决策及测试记录。