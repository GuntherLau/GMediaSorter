# 视频播放功能实施方案

## 1. 背景与目标
- 为视频管理流程补齐“预览/播放”能力，帮助用户快速核对视频内容。
- 提供独立播放器组件，支持基本控制（播放、暂停、进度、音量、倍速、全屏）。
- 保证与现有去重/相似检测、编码转换等功能的交互流畅，不引入明显性能负担。

## 2. 用户体验设计
### 2.1 入口与触发
- 视频卡片新增“播放”按钮，点击后打开播放器面板。
- 支持在重复/相似结果面板中直接点击文件名触发播放。

### 2.2 播放器呈现方式
- 默认以侧边抽屉或浮层对话框方式呈现，保持列表可见。
- 播放器支持拖动/关闭，面板内展示视频标题、路径、基础信息。
- 配置自动播放开关，初次打开默认为自动播放可选项。

### 2.3 交互元素
- 控制区：播放/暂停、进度条/拖拽、音量控制、倍速选择（0.5x~2x）、静音、全屏。
- 信息区：当前时间/总时长、文件名、分辨率、帧率等元数据（若可获取）。
- 键盘操作：空格切换播放、左右方向键跳 5 秒、上下调音量、F 键全屏。
- 错误提示：文件缺失或不支持的编码时展示友好提示。

## 3. 功能范围
- ✅ 播放本地文件（MP4/MKV/AVI/WEBM 等常见容器）并提供常用控制。
- ✅ 同一时间仅打开一个播放器实例，避免多视频同时播放。
- ✅ 支持记忆最近一次播放进度（可选功能，默认开启）。
- ✅ 双击或快捷键进入/退出全屏。
- ❌ 暂不支持画中画、字幕轨道选择、播放列表管理（列入后续扩展）。

## 4. 技术实现要点
### 4.1 渲染层
- `src/components/VideoPlayer.tsx` 使用原生 `<video>` 元素结合 `useRef` 控制播放，必要时可扩展到第三方播放器库。
- 播放器状态由 `App.tsx` 统一维护（`playerState` 与 `playerPreferences`），通过 props 驱动播放器组件。
- 组件内部负责键盘事件与全屏控制，并在播放器关闭时重置 `<video>` 状态。
- `localStorage` 记忆自动播放、循环与默认倍速等偏好，提升连续使用体验。

### 4.2 预加载层（`preload.ts`）
- 暴露 `openFilePreview(path: string)` 与 `getVideoMetadata(filePath)`，并对异常进行捕获转换为渲染层可读的错误。
- 通过 `contextBridge` 同步类型定义（见 `src/types.ts`），确保渲染层具备完整类型提示。

### 4.3 主进程（`electron/main.ts`）
- `ipcMain.handle('open-file-preview')` 校验文件存在性后返回 `gms-media://` 自定义协议链接，与 `protocol.registerFileProtocol` 联动避免 `file://` 载入限制。
- `ipcMain.handle('get-video-metadata')` 复用 ffprobe（fluent-ffmpeg）获取编码、容器、分辨率、帧率、码率等信息，并输出给渲染层。
- 当前未启用缓存逻辑，待后续针对重复调用场景评估优化。

### 4.4 文件访问与安全
- 现阶段依赖主进程 `fs.access` 校验文件可读性；下一步可加入扫描目录白名单校验。
- 如迁移到自定义协议，需要同步更新安全策略与 CSP。
- 所有错误会转化为用户可读的提示，指导刷新列表或检查磁盘状态。

## 5. 性能与资源考虑
- 播放器关闭/隐藏时自动调用 `video.pause()` 并释放引用。
- 大文件播放首帧延迟优化：使用 `preload="metadata"`，先加载元数据后再请求全量数据。
- 限制同时仅有一个 `<video>` 节点，避免多文件并行读取导致 I/O 压力。

## 6. 状态管理与集成
- 在 `App.tsx` 增加 `playerState`：`{ visible, source, title, currentTime, volume, playbackRate, autoPlay, looping }`。
- 将播放器组件放置在 App 根部，使用 Portal 渲染，确保全局覆盖。
- 视频卡片/面板触发时更新 `playerState.source` 并显示播放器。
- 监听 `<video>` 的 `timeupdate`, `error`, `ended` 事件，驱动 UI 状态与错误提示。

## 7. 测试策略
### 7.1 自动化
- 编写组件测试（使用 `@testing-library/react`）验证控件点击触发状态变更。
- mock `<video>` 元素方法，确保 play/pause/seek 调用逻辑正确。
- 主进程单元测试：验证 IPC 路径校验、错误处理、协议注册。

### 7.2 手工测试
- 不同容器/编码（H.264/H.265/VP9）播放兼容性。
- 大文件首帧时间、拖动进度条、倍速切换。
- 断开文件连接（删除/移动）后的错误提示。
- 全屏切换行为、键盘快捷键响应。
- 多窗口/多文件夹切换后播放器状态是否同步。

## 8. 任务拆分
| 序号 | 任务 | 状态 | 备注 |
| --- | --- | --- | --- |
| 1 | 需求确认与设计 | ✅ 已完成 | 方案文档定稿。 |
| 2 | IPC & 类型扩展 | ✅ 已完成 | `src/types.ts`/`preload.ts`/`electron/main.ts` 新增 `openFilePreview` 与元数据返回。 |
| 3 | 播放器组件开发 | ✅ 已完成 | 引入 `VideoPlayer` 组件与 `VideoPlayer.css`，支持播放控制与偏好记忆。 |
| 4 | 键盘与全屏支持 | ✅ 已完成 | 全局快捷键、静音/音量调节与全屏切换逻辑落地。 |
| 5 | 元数据展示 | ✅ 已完成 | 播放器展示编码、分辨率、码率信息，元数据由 ffprobe 提供。 |
| 6 | 自动化测试 | ✅ 已完成 | 新增 `VideoPlayer` 组件交互测试与 `App` 级 IPC 行为用例（Vitest + Testing Library）。 |
| 7 | 手工验证与优化 | ☐ 进行中 | 待多平台兼容性与性能验证。 |
| 8 | 文档与上线准备 | ✅ 已完成 | README/USER_GUIDE/TESTING 已更新播放说明。 |

## 9. 风险与缓解
- **格式兼容性**：部分编码器（如 HEVC Main10）在旧硬件/系统上无法播放，需在错误提示中明确说明，并考虑提供外部播放器打开选项。
- **I/O 性能**：大型文件拖动可能卡顿，建议增加加载中的视觉反馈。
- **安全限制**：macOS Sandboxing 或 Windows 权限导致 file:// 无法访问，需 fallback 到自定义协议或临时复制缓存目录（注意磁盘占用）。

## 10. 后续扩展方向
- 播放列表/队列管理、循环播放、随机播放。
- 截图/缩略图生成，辅助重复/相似分析。
- 字幕轨道选择、音轨切换。
- 可配置的画面裁剪、缩放模式（填充/适应/原始）。
- 多实例支持（并行比较两个视频）。
