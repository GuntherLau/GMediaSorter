# 视频编码格式转换功能方案

## 背景与目标

应用当前支持查看、筛选视频并执行重复/相似检测，但缺少对外导出或格式转换的能力。新增“视频编码格式转换”功能可帮助用户将选中的视频批量转码（例如从 H.264 转为 H.265），以满足体积压缩、兼容性或归档需求。本方案旨在：

- 在菜单栏提供“视频编码转换”入口
- 支持 H.264、H.265 两种目标编码的批量转换
- 每次转换前要求用户选择输出目录
- 逐个转换当前选中视频，保持原始文件名（必要时添加后缀）
- 显示进度和错误信息，保证可取消

## 用户交互流程

1. 用户勾选若干视频卡片。
2. 在菜单栏点击“工具”→“视频编码转换”。
3. 下拉菜单展开，显示可选目标编码：H.264、H.265（后续可扩展）。
4. 用户选择目标编码后，弹出系统目录选择对话框，指定输出目录。
5. 确认后开始批量转换：
   - 显示进度对话框（当前文件、完成数量、总数、转换耗时估计）。
   - 提供“取消转换”按钮。
6. 转换完成后弹出结果摘要（成功/失败数量、输出目录快捷打开）。

## UI & 菜单设计

- 在 Electron 主进程中新增菜单项 `工具 (Tools)` → `视频编码转换`。
- 点击后在渲染进程触发下拉菜单（可复用 Toolbar 样式，或使用自定义 Popover）。
- 下拉菜单项：
  - `转码为 H.264`
  - `转码为 H.265`
- 可在后续迭代增加“设置”入口（自定义码率、分辨率）。

## 功能需求

### 基本需求
- 支持选择的每个视频独立转码。
- 支持在转码前校验目标目录可写。
- 输出文件默认命名：`原名_编码后缀.扩展名`（例如 `video_h265.mp4`）。
- 记录失败原因并在结果摘要中展示。
- 转码过程中允许取消：停止队列并清理当前 ffmpeg 进程。

### 非功能性需求
- 转码时避免阻塞主线程，采用后台任务机制。
- 控制并发，默认串行，也可考虑配置成有限并发（例如 2 个同时）。
- 输出目录内存在同名文件时追加数字后缀，避免覆盖。
- 维护操作日志，便于调试。

## 技术方案

### 渲染进程
- 新增 `ConversionMenu` 组件，负责展示编码选项。
- 新增全局状态管理或上下文记录转换状态（进度、是否取消）。
- 通过 `window.electronAPI.requestConversion`（新 IPC 方法）触发后台任务。
- 接收主进程推送的进度事件 `conversion-progress`，更新进度对话框。
- 提供 `conversion-cancel` IPC 调用，通知主进程停止任务。

### 主进程
- Electron 主进程新增 `conversion-service`：
  - 排队处理传入的转换任务。
  - 调用 `ffmpeg` 执行转码：`ffmpeg -i input -c:v libx264 ... output`、`ffmpeg -i input -c:v libx265 ... output`。
  - 根据目标编码配置默认参数（码率、预设，可适度暴露配置）。
  - 监听渲染进程的取消请求，终止当前 ffmpeg 进程。
  - 使用 `p-limit` 控制并发。
  - 通过 IPC 发送进度更新：当前文件索引、成功数、失败数、日志。
- 负责弹出目录选择对话框 `dialog.showOpenDialog({ properties: ['openDirectory', 'createDirectory'] })`。

### 文件处理策略
- 输出文件扩展名与原文件一致（若容器支持 H.265）；必要时可统一为 `.mp4`。
- 对于不支持所选编码的输入格式（如部分老格式），需提前检测并提示失败。
- 转换完成后保留原始文件（不覆盖）。

### 错误与异常处理
- 捕获 ffmpeg 错误信息，记录到日志文件（可存储于 `logs/conversion.log`）。
- 如果用户未选择任何视频，菜单选项需置灰或提示。
- 用户取消时，返回“用户取消”状态，不计入失败。

## 数据结构与 IPC

### 新增类型
- `ConversionRequest`：包含目标编码、输出目录、待转换文件列表。
- `ConversionProgress`：当前索引、总数、当前文件名、成功/失败计数、耗时、状态。
- `ConversionResult`：成功列表、失败列表（含原因）。

### 新增 IPC 通道
- `conversion-start`：渲染进程 → 主进程，携带 `ConversionRequest`。
- `conversion-progress`：主进程 → 渲染进程，推送进度。
- `conversion-complete`：主进程 → 渲染进程，发送最终结果。
- `conversion-cancel`：渲染进程 → 主进程，请求中断。

## 开发分工建议

| 模块 | 负责人 | 主要任务 |
| --- | --- | --- |
| 菜单 & UI | 前端工程 | 菜单入口、下拉组件、进度对话框、结果展示 |
| IPC 接口 | 全栈/前端 | 扩展 `preload.ts`、定义类型、渲染端调用 |
| 主进程服务 | 后端/全栈 | 转换队列、ffmpeg 调用、进度推送、取消逻辑 |
| 日志 & 错误处理 | 全栈 | 日志记录、失败信息整理 |
| 测试 | QA/开发 | 单元测试（主进程服务）、端到端测试（模拟转换） |
| 文档 | 文档维护 | 更新 README、CHANGELOG、用户指南 |

## 迭代计划

### Iteration 1：基础能力（约 3 人日）
- 实现菜单按钮与下拉选择
- 渲染进程创建转换请求（静态参数）
- 主进程串行执行 ffmpeg 转换（H.264、H.265）
- 进度条/提示框基础展示

### Iteration 2：完善体验（约 3 人日）
- 输出目录选择对话框
- 文件命名冲突处理、错误提示
- 取消操作支持
- 结果汇总面板 + 打开目录按钮

### Iteration 3：扩展与优化（约 4 人日，可选）
- 并发/队列优化，可配置并发度
- 可选参数（码率、预设、音频编码）
- 缩略图更新（若需重新编码生成预览）
- 单元测试、E2E 测试补齐

## 风险与缓解措施

- **ffmpeg 兼容性**：确保打包时包含 libx264、libx265；必要时在安装指南中说明平台支持。
- **性能瓶颈**：大批量转码耗时长。可新增进度估计与剩余时间提示，并允许后台运行。
- **用户误操作**：输出目录为空/无权限。需在转换前校验并提示。
- **取消时资源释放**：在取消逻辑中调用 `ffmpegProc.kill('SIGTERM')` 并清理临时文件。

## 测试计划

- 单文件转换：H.264 → H.265、H.265 → H.264。
- 批量转换：多个不同格式的视频，验证命名冲突处理。
- 取消流程：转换中途取消后进度停止且未生成残留文件。
- 错误场景：损坏视频、无写入权限目录、目标目录满。
- UI 测试：菜单禁用状态（无选中文件）、进度显示正确。

## 待办任务拆分

1. **菜单与前端交互**
   - [x] 主菜单新增“工具 → 视频编码转换”入口
   - [x] 渲染进程监听菜单事件，触发下拉组件
   - [x] 开发 `ConversionMenu` 组件（含 H.264/H.265 选项）
   - [x] 无选中文件时禁用或提示

2. **目录选择与请求组装**
   - [x] 使用 `dialog.showOpenDialog` 选择输出目录
   - [x] 构建 `ConversionRequest` 数据结构
   - [x] 扩展 `preload.ts` 暴露 `requestConversion`

3. **主进程转换服务**
   - [x] 创建 `conversion-service`，封装转换队列与状态
   - [x] 接入 `fluent-ffmpeg` 调用，配置 libx264/libx265 参数
   - [x] 处理命名冲突、输出文件写入
   - [x] 支持取消，确保终止当前进程

4. **进度与结果展示**
   - [x] 新建 `ConversionProgressDialog` 组件显示当前状态
   - [x] 渲染进程订阅 `conversion-progress`、`conversion-complete`
   - [x] 结果摘要视图（成功/失败列表、打开目录按钮）

5. **日志与错误处理**
   - [x] 主进程记录错误日志到 `logs/`
   - [x] 转换失败原因返回前端展示
   - [x] 取消操作视为成功终止，不计失败

6. **测试与文档**
   - [ ] 单元测试：文件命名、错误流程、取消
   - [ ] 集成测试：模拟批量转换
   - [x] 更新 README（功能特性、使用说明、开发计划）
   - [x] 更新 CHANGELOG（新增转换功能）

---

该方案在保持现有架构（Electron 主进程 + React 渲染进程）基础上扩展转码能力，重点关注用户操作流程、任务队列与资源释放，确保基础功能上线后可逐步扩展到更多编码格式和高级参数。