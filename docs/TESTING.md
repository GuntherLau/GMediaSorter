# 视频去重与相似检测功能测试指南

## 测试准备

1. 准备测试视频文件：
   - 至少 3-5 个视频文件
   - 包含一些完全相同的副本（相同内容但不同文件名）
   - 可选：包含一些相似的视频（相同场景的不同剪辑）

2. 启动应用：
   ```bash
   npm run electron:dev
   ```

## 功能测试清单

### 1. 工具栏显示

- [ ] 选择包含视频的文件夹后，工具栏应该出现在过滤栏上方
- [ ] 工具栏显示"🔍 找相同"和"🎯 找相似"两个按钮
- [ ] 工具栏右侧显示视频总数

### 2. 找相同功能测试

#### 2.1 基本检测

- [ ] 点击"找相同"按钮
- [ ] 应该弹出进度对话框，显示检测进度
- [ ] 进度对话框显示：
  - 进度百分比
  - 当前/总计文件数
  - 当前处理的文件名
  - 阶段信息（快速扫描/精确验证）

#### 2.2 检测结果

如果有重复文件：
- [ ] 检测完成后显示重复文件面板
- [ ] 面板顶部显示统计信息：
  - 重复组数
  - 重复文件总数
  - 浪费空间大小
  - 扫描耗时
- [ ] 每个重复组可以展开/折叠
- [ ] 展开后显示该组的所有重复文件
- [ ] 最早修改的文件被标记为"保留"（绿色背景）

如果没有重复文件：
- [ ] 显示"未发现重复文件"的空状态

#### 2.3 批量删除操作

- [ ] 点击"选择重复项（保留最早）"按钮
- [ ] 除了标记为"保留"的文件外，其他文件被选中（黄色背景）
- [ ] 也可以手动点击文件勾选框来选择/取消选择
- [ ] 顶部显示"已选中 X 个文件"
- [ ] 点击"删除选中"按钮
- [ ] 弹出确认对话框
- [ ] 确认后文件被删除，视频列表自动刷新

#### 2.4 取消操作

- [ ] 在检测过程中点击"取消"按钮
- [ ] 检测应该停止，进度对话框关闭

### 3. 找相似功能测试

#### 3.1 基本检测

- [ ] 点击"找相似"按钮
- [ ] 应该弹出进度对话框，显示检测进度
- [ ] 进度对话框显示三个阶段：
  - 预筛选中
  - 提取视频特征中
  - 计算相似度中

#### 3.2 检测结果

如果有相似视频：
- [ ] 检测完成后显示相似视频面板
- [ ] 面板顶部显示统计信息：
  - 相似组数
  - 相似文件总数
  - 相似度阈值
  - 扫描耗时
- [ ] 每个相似组可以展开/折叠
- [ ] 展开后显示：
  - 该组的所有相似文件
  - 相似度详情部分，显示每对文件的相似度评分
- [ ] 相似度评分包括：
  - 综合相似度（紫色，较大字体）
  - 视觉相似度
  - 时长相似度
  - 分辨率相似度
  - 文件大小相似度

如果没有相似视频：
- [ ] 显示"未发现相似视频"的空状态
- [ ] 提示"尝试降低相似度阈值"

#### 3.3 取消操作

- [ ] 在检测过程中点击"取消"按钮
- [ ] 检测应该停止，进度对话框关闭

### 4. UI/UX 测试

#### 4.1 响应式设计

- [ ] 工具栏按钮在禁用状态下显示灰色
- [ ] 检测过程中工具栏按钮被禁用
- [ ] 结果面板可以通过点击 ✕ 关闭
- [ ] 面板内容超出时可以滚动

#### 4.2 视觉效果

- [ ] 进度条平滑过渡
- [ ] 按钮悬停效果正常
- [ ] 选中的文件有明显的视觉反馈
- [ ] 代表文件（保留项）有特殊的颜色标识

#### 4.3 错误处理

- [ ] 如果视频文件无法访问，应该有错误提示
- [ ] 删除文件失败时应该有错误提示
- [ ] 网络或其他异常应该有友好的错误信息

### 5. 性能测试

- [ ] 测试 10 个视频文件的检测速度
- [ ] 测试 50 个视频文件的检测速度（如果可用）
- [ ] 检测大文件（>1GB）时应用不应该卡顿或崩溃
- [ ] 检测过程中可以取消，不会导致应用无响应

### 6. 边界情况测试

- [ ] 只有 1 个视频文件时点击"找相同"
- [ ] 只有 1 个视频文件时点击"找相似"
- [ ] 所有视频都不同时的检测结果
- [ ] 视频列表为空时工具栏按钮应该被禁用
- [ ] 在检测过程中切换文件夹的行为

### 7. 视频转码功能测试

#### 7.1 菜单与入口

- [ ] 未选择视频时，菜单项应提示或禁用（弹出面板按钮灰显）
- [ ] 选择多个视频后，点击 菜单 → 工具 → 视频编码转换 可展开下拉菜单
- [ ] 菜单中显示 "转码为 H.264" 和 "转码为 H.265" 两个选项

#### 7.2 转码流程

- [ ] 选择目标编码后弹出目录选择器，允许新建文件夹
- [ ] 选择输出目录后出现进度对话框，显示进度条和当前文件名
- [ ] 转码完成后自动弹出结果摘要，显示成功/失败数量及耗时
- [ ] 点击 "打开输出目录" 按钮可打开系统文件夹
- [ ] 成功文件命名规则为 `原名_编码后缀.扩展名`，同名文件追加数字序号

#### 7.3 取消与失败处理

- [ ] 转码过程中点击 "取消转换"，进度对话框关闭并在结果中标记为已取消
- [ ] 取消后已完成的视频保留在成功列表，正在处理的视频不记为失败
- [ ] 模拟失败（如输出目录改为只读）时，失败列表展示错误提示
- [ ] 检查 `用户数据目录/logs/conversion.log`，失败记录写入日志

#### 7.4 组合场景

- [ ] 同时选择不同扩展名的视频（mp4/mkv 等）转码成功
- [ ] 选择超过 10 个文件时，进度条按文件数推进且界面无卡顿
- [ ] 重复执行多次转码任务，确保第二次开始前前一个任务已完全结束

### 8. 容器格式转换功能测试

#### 8.1 自动化回归

- [ ] 运行 `npm run test`，确保 `ContainerConversionService` 成功/失败/取消场景的单元测试全部通过

#### 8.2 菜单与入口

- [ ] 工具栏灰度显示“容器转换”按钮（无可处理文件时禁用）
- [ ] 菜单栏 `工具 → 容器格式转换` 可唤起容器格式选择面板
- [ ] 面板默认选中上一次的目标容器

#### 8.3 转换流程

- [ ] 选择目标容器后弹出输出目录选择器，支持新建文件夹
- [ ] 指定输出目录后进入进度对话框，显示目标容器、成功/失败计数与当前文件
- [ ] 输出文件命名规则 `原名_容器后缀.扩展名`（如 `sample_mp4.mp4`）且发生命名冲突时自动追加序号
- [ ] 当源文件本身已是目标容器时，任务跳过 remux 并执行快速复制（可通过日志或进度统计确认）

#### 8.4 取消与异常处理

- [ ] 进度对话框的“取消转换”按钮在任务进行中可用，点击后立即更新为“已取消”状态
- [ ] 取消时仅保留已完成文件，未开始的队列不再执行
- [ ] 无写入权限的输出目录会导致失败条目，错误信息同步到结果面板与日志
- [ ] `logs/container-conversion.log` 记录成功/失败详情

#### 8.5 结果与回溯

- [ ] 结果摘要展示成功/失败数量、耗时与目标容器
- [ ] “查看日志”按钮可打开容器转换日志
- [ ] “打开输出目录”按钮可跳转到系统文件管理器
- [ ] 结果面板关闭后可再次启动新的容器转换任务

## 已知限制

1. **相似检测性能**：
   - 视频指纹提取需要解码视频帧，对于大量视频可能耗时较长
   - 建议每次检测不超过 100 个视频

2. **相似度阈值**：
   - 当前固定为 80%，后续可改为用户可配置

3. **删除操作**：
   - 直接删除文件，不经过回收站
   - 建议在删除前做好备份

4. **ffmpeg 依赖**：
   - 需要 ffmpeg 支持，某些特殊编码的视频可能无法提取帧

## 测试结果记录

| 测试项 | 通过 | 失败 | 备注 |
|--------|------|------|------|
| 工具栏显示 | ☐ | ☐ | |
| 找相同-基本检测 | ☐ | ☐ | |
| 找相同-结果展示 | ☐ | ☐ | |
| 找相同-批量删除 | ☐ | ☐ | |
| 找相似-基本检测 | ☐ | ☐ | |
| 找相似-结果展示 | ☐ | ☐ | |
| UI/UX | ☐ | ☐ | |
| 性能 | ☐ | ☐ | |
| 边界情况 | ☐ | ☐ | |
| 视频转码功能 | ☐ | ☐ | |
| 容器格式转换功能 | ☐ | ☐ | |

## 反馈

测试过程中发现的问题或改进建议：

1. 
2. 
3.
