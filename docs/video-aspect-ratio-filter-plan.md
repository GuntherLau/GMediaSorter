# 视频长宽比过滤功能方案

## 1. 背景与动机

- 当前主界面已支持按分辨率、时长等维度过滤视频，但缺乏对画面形态（横屏 / 竖屏 / 超宽屏 等）的快速筛选能力。
- 实际整理场景中，用户常需要分别处理竖屏素材（短视频）、标准 16:9 视频（常规节目）、或 2.35:1 电影级素材；提供长宽比过滤可大幅提高查找效率。
- 长宽比与分辨率、时长不冲突，应支持“AND” 叠加组合，实现多维度精准筛选。

## 2. 功能目标

1. 在过滤面板中新增“长宽比”维度，提供一组预设选项覆盖常见画面形态。
2. 允许与既有分辨率、时长过滤同时生效，满足组合查询需求。
3. 对缺失或异常元数据的视频做合理兜底，避免误排除。
4. 保持现有 UI/UX 风格与组件复用，降低实现复杂度。

## 3. 用户场景

- **短视频剪辑**：只查看竖屏 (9:16) 素材，用于 Reels / 抖音 等渠道。
- **电影整理**：过滤出 2.35:1 或更宽的电影源，方便重新封装或转码。
- **课件维护**：只保留标准 16:9 录屏，剔除纵向手机拍摄内容。
- **多维查询**：在“1080p & 时长 2-10 分钟”的条件下，再过滤出“标准横屏”素材。

## 4. 需求与交互原则

### 4.1 预设分组（草案）

| 分组键值 | 显示标签 | 数值范围 (宽 / 高) | 说明 |
| --- | --- | --- | --- |
| `all` | 全部 | 任意 | 默认状态 |
| `portrait` | 竖屏 (< 1.0) | 0 < ratio < 0.9 | 典型 9:16 / 3:4 |
| `square` | 方形 (≈1:1) | 0.9 ≤ ratio ≤ 1.1 | 包括近似正方形画面 |
| `standard` | 标准横屏 (≈16:9) | 1.1 < ratio ≤ 1.9 | 16:9 / 4:3 / 3:2 |
| `ultrawide` | 宽屏 (>1.9) | ratio > 1.9 | 21:9 / 2.39:1 电影 |

> 备注：具体阈值可在实现阶段根据样本微调；所有区间互斥，避免重复命中。

### 4.2 交互规则

- 维持与现有 `FilterDimension` 一致的“Chip” 交互方式，单选互斥。
- 选中后立即更新列表，无需额外确认按钮。
- 当视频缺失宽/高数据时：
  - 在“全部”状态下照常显示。
  - 在其他档位下默认判定为匹配，并在摘要中展示当前维度选择，提醒用户关注数据质量。
- 清除全部过滤时，该维度回到 `all`。
- 选项文本直接展示典型比例（如 “16:9 标准横屏”），便于用户快速识别目标画面形态。
- 当存在缺失数据时，在摘要区域提供“仅查看未知”快捷按钮，可一键聚焦异常素材，并支持返回上一档位。

## 5. 技术方案概览

### 5.1 数据来源与处理

- 现有 `VideoFile` 类型包含 `width` / `height` / `aspectRatio` 字段。
- 若 `aspectRatio` 未提供，可在渲染进程按 `width / height` 计算，并使用 `Math.max(width, height)` / `Math.min(width, height)` 避免竖屏取值小于 1 时难于比较。
- 统一将比值保留 2 位小数，供 UI 显示与调试。

### 5.2 类型与配置扩展

- `src/types.ts`
  - 新增 `AspectRatioPreset`、`AspectRatioFilter`、更新 `FilterState`。
- `src/config/filters.ts`
  - 新增 `aspectRatioDimension` 配置；`allFilterDimensions`、`defaultFilterValues` 包含新维度。
- `FilterPanel` / `FilterSummary`
  - 引入新维度；更新统计展示（例如在摘要中突出被过滤掉的数量）。

### 5.3 过滤逻辑

- `src/utils/filters.ts`
  - 添加 `matchAspectRatioFilter(ratio: number | null, filter: AspectRatioFilter)`。
  - 在 `matchAllFilters` 中按顺序调用：分辨率 → 时长 → 长宽比。
- 为避免浮点误差，比较时使用 `ratio >= lower && ratio < upper` 的闭开区间；阈值常量集中定义。

### 5.4 UI / 状态流

- `FilterPanel`：新增 `FilterDimension` 实例，与现有布局保持一致。
- `FilterSummary`：在摘要文案中加入“长宽比：标准横屏”等提示，并在发现缺失元数据时追加“含 X 个未知长宽比”提醒。
- `FilterPanel.css`/`FilterChip.css` 如需微调宽度以容纳更多选项。

### 5.5 持久化与复位

- 若现有过滤状态存储在 localStorage（例如 `App.tsx`），需同步保存新增字段，确保刷新后仍保留选择。
- 清除按钮 (`onClearAll`) 需覆盖新维度。

## 6. 验收标准

1. 过滤面板新增“长宽比”一栏，选项与方案一致，UI 风格统一。
2. 与分辨率、时长过滤同时启用时，视频列表命中逻辑满足“AND” 条件。
3. 竖屏 / 方形 / 宽屏样本命中结果正确；对无元数据视频有清晰提示或默认行为。
4. 切换过滤器后列表刷新无明显性能问题（针对 1000 条数据级别测试）。
5. 过滤状态缓存、清空行为与既有逻辑一致。
6. 单元测试覆盖：
   - `matchAspectRatioFilter` 各档位判断。
   - `matchAllFilters` 多维组合场景。

## 7. 风险与缓解

| 风险 | 影响 | 缓解措施 |
| --- | --- | --- |
| 视频宽高元数据缺失 | 筛选不准确 | 采用宽松兜底策略，并在 UI 标注“未知长宽比”数量 |
| 视频已旋转但元数据未更新 | 分类出现偏差 | 允许用户通过“全部”快速复位；后续可引入 EXIF 方向检测 |
| 与现有过滤 UI 并列，空间拥挤 | 影响可读性 | 自适应折行，必要时将文案缩短（如“竖屏”/“标准横屏”） |
| 区间边界需调优 | 用户误解 | 在测试阶段采集样本，调整阈值并在文档说明 |

## 8. 任务拆分与里程碑

| 阶段 | 任务 | 交付 | 预计耗时 |
| --- | --- | --- | --- |
| Phase 1 | 类型与配置准备 | `AspectRatioPreset`、`aspectRatioDimension`、默认值更新 | 0.5 天 |
| Phase 1 | 过滤工具扩展 | `matchAspectRatioFilter`、单元测试 | 0.5 天 |
| Phase 2 | UI 集成 | FilterPanel / FilterSummary / Chip 调整，本地化文案 | 0.5 天 |
| Phase 2 | 状态持久化 | App 状态、localStorage 兼容升级 | 0.5 天 |
| Phase 3 | 手工验收 | 准备测试素材（竖屏、宽屏、1:1），验证组合过滤 | 0.5 天 |
| Phase 3 | 文档与回顾 | 更新 `FilterPanel` 使用说明、测试手册条目 | 0.5 天 |

## 9. 测试与验证

- **自动化**：
  - New Vitest cases covering阈值、组合过滤。
  - Snapshot/RTL 测试确认新维度渲染与交互。
- **手工测试**：
  - 按方案新增至 `docs/TESTING.md` 的过滤章节，覆盖常见与边界长宽比。

## 10. 后续演进（可选）

- 自定义范围输入：允许用户输入最小 / 最大长宽比。
- 结合智能标签：自动标注竖屏内容，支持批量移动或标记。
- 统计面板：展示当前目录中各长宽比占比，辅助素材管理决策。

## 11. 实施进展

- **2025-11-18 早间**：完成 Phase 1/2 任务；已实现类型定义、配置元数据、过滤工具函数、FilterPanel UI 集成与状态摘要展示，并补充 Vitest 单元测试覆盖长宽比过滤逻辑；测试手册已加入长宽比验收条目，界面新增“含 X 个未知长宽比”提示、补齐“仅查看未知”快捷按钮并统一转换类按钮样式。
- **2025-11-18 下午**：完成 Phase 3 手工验收，使用竖屏/方形/标准横屏/超宽屏及缺失元数据样本验证过滤命中、组合筛选与“仅查看未知”按钮行为，结论为符合预期；测试手册已补充验证记录，本方案进入收尾状态。

---

> 本文档作为“长宽比过滤”功能的上线依据，请在开发过程中同步更新实施细节与测试结果记录。
