# 视频去重与相似检测功能使用指南

## 功能概述

GMediaSorter 提供了强大的视频整理、转换能力，帮助您：

- 🔍 **找相同**：发现完全重复的视频文件，释放存储空间
- 🎯 **找相似**：识别内容相似的视频，便于整理和归档
- 🎞️ **视频编码转换**：批量将视频转为 H.264 / H.265
- 📦 **容器格式转换**：无损调整封装格式（MP4 / MKV）

## 找相同：重复文件检测

### 使用场景

- 清理备份目录中的重复视频
- 整理下载文件夹中的重复内容
- 释放被重复文件占用的存储空间

### 工作原理

1. **快速预筛选**：
   - 读取文件的头部、中部、尾部片段
   - 计算快速哈希值进行初步分组
   - 速度快，适合大量文件

2. **精确验证**：
   - 对疑似重复的文件计算完整哈希
   - 确保 100% 准确，不会误判
   - 只对必要的文件进行完整扫描

### 使用步骤

1. **扫描视频文件**
   ```
   选择文件夹 → 等待扫描完成
   ```

2. **开始检测**
   ```
   点击工具栏的"🔍 找相同"按钮
   ```

3. **查看进度**
   - 实时显示检测进度
   - 显示当前处理的文件
   - 可随时点击"取消"按钮中止

4. **查看结果**
   - **重复组数**：发现了多少组重复文件
   - **重复文件数**：总共有多少个重复文件
   - **浪费空间**：重复文件占用的额外空间
   - **扫描耗时**：检测花费的时间

5. **处理重复文件**
   
   **方式一：快速清理**
   ```
   展开重复组 → 点击"选择重复项（保留最早）" → 点击"删除选中"
   ```
   
   **方式二：手动选择**
   ```
   展开重复组 → 手动勾选要删除的文件 → 点击"删除选中"
   ```

### 特性说明

- **智能保留**：自动将最早修改的文件标记为"保留"（绿色标识）
- **批量操作**：支持一次性删除多个文件
- **安全确认**：删除前会弹出二次确认对话框
- **自动刷新**：删除后视频列表自动更新

### 注意事项

⚠️ **删除操作不可撤销**，建议：
- 删除前仔细核对要保留的文件
- 重要文件建议先备份
- 可以先手动移走重要文件，再批量删除

## 找相似：内容相似检测

### 使用场景

- 发现相同场景的不同剪辑
- 整理重复拍摄的视频片段
- 识别经过编辑（剪辑、滤镜、压缩）的相似视频

### 工作原理

1. **元数据预筛选**（L1）：
   - 比较视频时长、分辨率、文件大小
   - 快速排除明显不相似的视频
   - 减少后续计算量

2. **视频指纹提取**（L2）：
   - 提取视频关键帧（每 5 秒一帧）
   - 计算每帧的感知哈希（pHash）
   - 生成视频的视觉指纹序列

3. **相似度计算**（L3）：
   - 比较视频指纹的汉明距离
   - 计算多维度相似度评分
   - 综合评估整体相似度

### 使用步骤

1. **扫描视频文件**
   ```
   选择文件夹 → 等待扫描完成
   ```

2. **开始检测**
   ```
   点击工具栏的"🎯 找相似"按钮
   ```

3. **查看进度**
   - **预筛选中**：快速比对元数据
   - **提取视频特征中**：解码视频帧，计算感知哈希
   - **计算相似度中**：比对视频指纹

4. **查看结果**
   - **相似组数**：发现了多少组相似视频
   - **相似文件数**：总共有多少个相似文件
   - **相似度阈值**：当前使用的判定阈值（默认 80%）
   - **扫描耗时**：检测花费的时间

5. **分析相似度**
   
   **展开相似组**可以看到：
   - 该组包含的所有相似文件
   - 平均相似度评分
   - 详细的两两配对评分

   **相似度评分包括**：
   - **综合**：综合评估结果（权重最高）
   - **视觉**：画面内容相似度（基于 pHash）
   - **时长**：视频长度相似度
   - **分辨率**：视频分辨率相似度
   - **大小**：文件大小相似度

6. **处理相似视频**
   - 根据相似度评分判断是否为重复内容
   - 手动选择要保留的版本
   - 在文件管理器中进一步处理

### 特性说明

- **智能分组**：使用并查集算法自动分组相似视频
- **多维评分**：从多个角度评估相似度，更准确
- **鲁棒性强**：对压缩、缩放、色彩调整具有容忍性

### 相似度阈值说明

| 阈值范围 | 说明 | 适用场景 |
|---------|------|---------|
| 90%-100% | 极高相似 | 几乎完全相同，可能只有轻微编辑 |
| 80%-90% | 高度相似 | 相同场景，可能有剪辑或压缩 |
| 70%-80% | 中度相似 | 部分内容重叠 |
| 60%-70% | 低度相似 | 仅有少量相似片段 |

**当前阈值**：80%（平衡准确度和召回率）

### 注意事项

⏱️ **相似检测较耗时**，建议：
- 每次检测不超过 100 个视频
- 大量视频可分批检测
- 检测过程中可随时取消

🎯 **检测准确度取决于**：
- 视频编码质量
- 关键帧提取效果
- 相似度阈值设置

## 视频编码转换

### 使用场景

- 针对旧设备或移动端兼容性，将 H.265 视频转为 H.264
- 通过高质量预设重新编码，平衡体积与画质
- 批处理素材，统一编码格式以便后续剪辑

### 使用步骤

1. **选择视频列表**：筛选出需要转换的视频（默认处理当前过滤后的全部文件）。
2. **唤起菜单**：点击工具栏“视频转码”或菜单栏 `工具 → 视频编码转换`。
3. **配置目标编码**：在弹出的面板中选择 H.264 / H.265 及音频策略。
4. **确认输出目录**：完成系统目录选择对话框，支持新建文件夹。
5. **查看进度**：进度框实时显示当前文件、成功/失败数量，可随时取消。
6. **查看结果**：结果面板展示摘要，可一键打开输出目录或查看日志。

### 注意事项

- 输出文件命名为 `原名_编码后缀.扩展名`，若重名自动追加序号。
- 取消操作会停止剩余队列，已完成文件保留。
- 失败记录写入 `logs/conversion.log`，便于排查。

## 容器格式转换

### 使用场景

- 在不重新编码的情况下批量转换封装（如从 TS/MOV 转为 MP4）。
- 合并不同来源的视频库，统一封装格式以兼容播放器。
- 快速验证容器兼容性，定位封装相关的播放问题。

### 使用步骤

1. **准备列表**：调整过滤器，确定要处理的文件集合（默认为当前过滤结果）。
2. **打开面板**：点击工具栏“容器转换”按钮或菜单栏的对应入口。
3. **选择目标容器**：在弹窗中切换 MP4 或 MKV，确认后进入目录选择。
4. **指定输出目录**：支持新建文件夹，目录确认后立即开始转换。
5. **监控进度**：进度对话框显示目标容器、成功/失败计数以及当前文件。
6. **快速复制优化**：若源文件已为目标容器，系统会跳过 remux 直接复制到输出目录。
7. **查看摘要**：转换完成或取消后弹出结果面板，可打开输出目录或查看日志。

### 注意事项

- 转换过程中使用 `ffmpeg -c copy`，不会改变音/视频编码。
- 输出命名规则为 `原名_容器后缀.目标扩展`（如 `sample_mp4.mp4`）。
- 已符合目标容器的视频会执行快速复制，避免重复封装。
- 当输出目录无写入权限或流不兼容时，会展示失败原因并写入 `logs/container-conversion.log`。
- 可在进度对话框中随时取消，未处理的文件会被跳过。

## 性能优化建议

### 提升检测速度

1. **减少文件数量**
   - 使用分辨率过滤先筛选
   - 分批次处理大量视频

2. **关闭其他应用**
   - 释放 CPU 资源
   - 避免磁盘 I/O 竞争

3. **使用 SSD**
   - 加快文件读取速度
   - 提升哈希计算效率

### 避免误删

1. **先查看统计信息**
   - 了解检测到的重复/相似情况
   - 评估是否符合预期

2. **逐组处理**
   - 展开每个组查看详情
   - 确认后再删除

3. **重要文件先备份**
   - 检测前备份重要视频
   - 或先移到其他文件夹

## 常见问题

### Q: 为什么找相同没有发现重复文件？

A: 可能的原因：
- 文件确实没有完全重复
- 文件虽然内容相同但经过重新编码（尝试使用"找相似"）
- 文件损坏导致哈希值不同

### Q: 为什么找相似耗时很长？

A: 相似检测需要：
- 解码视频帧（CPU 密集）
- 计算感知哈希（需要图像处理）
- 对于高清大文件会更慢

建议：
- 减少每次检测的视频数量
- 使用性能更好的电脑
- 耐心等待或点击取消

### Q: 相似度评分如何理解？

A: 评分说明：
- **0-0.6**：不相似或低度相似
- **0.6-0.8**：中度相似，可能有部分重叠
- **0.8-0.95**：高度相似，建议仔细比对
- **0.95-1.0**：极高相似，几乎相同

### Q: 删除后能恢复吗？

A: 不能！当前版本直接删除文件，不经过回收站。

建议：
- 删除前做好备份
- 或考虑先移动到临时文件夹
- 确认无误后再永久删除

### Q: 如何调整相似度阈值？

A: 当前版本阈值固定为 80%。

未来版本计划：
- 提供阈值配置界面
- 支持自定义检测维度
- 保存用户偏好设置

## 技术细节

### 哈希算法

- **快速哈希**：MD5（文件头+中+尾）
- **完整哈希**：MD5（流式读取）
- **感知哈希**：BlockHash（8x8 bits）

### 相似度权重

默认权重配置：
```
视觉相似度：50%
时长相似度：20%
分辨率相似度：15%
文件大小相似度：15%
```

### 并发控制

- 哈希计算：流式读取，无并发限制
- 指纹提取：最多同时处理 2 个视频

## 更新日志

查看完整更新历史：[CHANGELOG.md](CHANGELOG.md)

## 反馈与建议

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！
